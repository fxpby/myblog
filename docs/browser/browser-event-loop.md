---
id: browser-event-loop
title: 浏览器事件循环
tags:
  - 浏览器
---

## 1.浏览器的进程模型

### 1.1 进程

程序运行需要有专属的**内存空间**，可以简单把这块内存空间理解为进程

每个应用至少有一个进程，进程之间相互独立

### 1.2 线程

有了进程，才可以运行程序代码，运行代码的对象即线程

一个进程至少有一个线程，进程开启后会自动创建一个线程运行代码，该线程即为主线程，主线程结束意味着整个程序结束

程序往往需要同时执行多块代码，主线程会启动更多线程来执行相关代码，故**一个进程中可以包含多个线程**

### 1.3 浏览器的进程和线程

浏览器是一个多进程多线程的应用程序

为了避免互相影响，减少崩溃概率，启动浏览器后，会自动启动多个进程

其中较为重要的是**浏览器进程**、**网络进程**和**渲染进程**

可以在浏览器的任务管理器查看当前的所有进程（更多 => 更多工具 => 任务管理器）

#### 1.3.1 浏览器进程

主要负责界面展示、用户交互、子进程管理（包括后面的网络进程和渲染进程等）等，浏览器进程内部会启动多个线程处理不同任务

#### 1.3.2 网络进程

负责加载网络资源，网络进程内部会启动多个线程处理不同任务

#### 1.3.3 渲染进程

渲染进程启动后，会开启一个**渲染主线程**，渲染主线程负责执行 HTML、CSS、JS 代码

默认情况下，浏览器会为每个标签页开启一个新的渲染进程来保证不同标签页之间不会相互影响（后续可能会改成一个站点一个进程 site-per-process）

> <https://chromium.googlesource.com/chromium/src/+/main/docs/process_model_and_site_isolation.md>

## 渲染主线程工作模式

渲染主线程非常繁忙，处理的任务包括但不限于👇🏻

- 解析 HTML
- 解析 CSS
- 计算样式
- 布局
- 处理图层
- 每秒画页面 60 次(FPS)
- 执行全局 JS 代码
- 执行事件处理函数
- 执行计时器的回调函数
- ......

主线程还会遇到一个致命难题 - 如何调度任务

- 如正在执行一个 JS 函数，执行到一半用户点击按钮，立即执行点击事件处理函数吗？
- 如正在执行一个 JS 函数，执行到一半某计时器刚好到达时间，立即执行回调吗？
- 如浏览器进程通知“用户点击了按钮”，同时某计时器刚好到达时间，应该处理哪个？

答案：**排队**

![渲染主线程 1](https://fxpby.oss-cn-beijing.aliyuncs.com/blogImg/browser/%E6%B8%B2%E6%9F%93%E4%B8%BB%E7%BA%BF%E7%A8%8B1.svg)

1. 最开始时，渲染主线程进入一个无限循环(<https://github.com/chromium/chromium/blob/4ff7e1c7fcf513a8da886d4246637a1c5d163a44/base/message_loop/message_pump_default.cc#L35>)
2. 每一次循环会检查消息队列中是否有任务存在；如果有则取出第一个任务执行，执行完进入下一层循环；如果没有则进入休眠状态
3. 其他所有线程（包括其他进程的线程）可以随时向消息队列添加任务。新任务会加到消息队列的末尾。在添加新任务时，如果主线程是休眠状态，则会被唤醒继续循环拿取任务

上述过程即**事件循环（消息循环）**
