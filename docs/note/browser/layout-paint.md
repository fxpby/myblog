# 浏览器的重排和重绘

浏览器渲染过程在解析 `HTML` 后，会依次进入 `Layout` 和 `Paint` 阶段。**样式或节点的更改，以及对布局信息的访问**，都有可能导致重排和重绘。
重排和重绘的过程在主线程中进行，不合理的重排重绘会导致**渲染卡顿，用户交互滞后**等性能问题

## 什么是重排和重绘

### 基础概念

- `Parse HTML`：相关引擎分别解析文档和样式表及脚本，生成 `DOM` 和 `CSSOM`，最终合成 `Render 树`
- `Layout`：浏览器通过 `Render 树`中的信息，以递归的形式计算出每个节点的尺寸大小和在页面中的具体位置
- `Paint`：浏览器将 `Render 树`中的节点转换成在屏幕上绘制实际像素的指令，此过程发生在多个图层上
- `Composite`：浏览器将所有层按照一定顺序合并为一个图层并绘制在屏幕上

`DOM` 或 `CSSOM` 被修改，会导致浏览器重复执行上述步骤。重排和重绘，本质上是触发 `Layout` 和 `Paint` 的过程，并且**重排必定导致重绘**

### 引起重排/重绘的常见操作

- 外观有变化时，会导致重绘，比如修改 `color` `opacity` 等样式属性
- 布局结构或者节点内容变化时，会导致重排，比如修改 `height` `float` `position` 等样式属性
  - 盒子尺寸和类型
  - 定位方案（正常流、浮动和绝对定位）
  - 文档树中元素之间的关系
  - 外部信息（如视口大小）
- 获取布局信息时，会导致重排，比如使用 `offsetTop` `getComputedStyle`

## 如何减少重排重绘

- 对 `DOM` 进行批量写入和读取（通过 `虚拟DOM` 或者 `DocumentFragment` 实现）
- 避免对样式进行频繁操作，了解常用样式属性触发 Layout/Paint/Composite 的机制，合理使用样式
- 合理利用特殊样式属性（如 `transform: translateZ(0)` 或者 `will-change`）, 将渲染层提升为合成层，开启 `GPU 加速`，提高页面性能
- 使用变量对布局信息（如 `clientTop`进行缓存，避免频繁读取布局信息触发重排和重绘）
- 借助 `DevTools Performance` 面板查看重排重绘任务占用主线程的情况和调用代码
